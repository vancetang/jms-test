<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IBM MQ 監控面板</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
      .card-header {
        background-color: #f8f9fa;
        font-weight: bold;
        border-radius: 8px 8px 0 0 !important;
      }
      .status-running {
        color: #28a745;
        font-weight: bold;
      }
      .status-error {
        color: #dc3545;
        font-weight: bold;
      }
      .refresh-btn {
        margin-bottom: 20px;
      }
      .loading {
        display: none;
        margin-left: 10px;
      }
      .loading-spinner {
        width: 1rem;
        height: 1rem;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
        display: inline-block;
        vertical-align: text-bottom;
      }
      @keyframes spinner-border {
        to {
          transform: rotate(360deg);
        }
      }
      .table th {
        background-color: #f8f9fa;
      }
      .auto-refresh-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .auto-refresh-container label {
        margin-right: 10px;
        margin-bottom: 0;
      }
      .auto-refresh-container select {
        width: 100px;
      }
      .last-updated {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 5px;
      }
      .error-message {
        color: #dc3545;
        font-weight: bold;
      }
      .add-queue-form {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }
      .performance-info {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1 class="mb-4">IBM MQ 監控面板</h1>

      <div class="alert alert-info">
        <strong>注意：</strong> 此版本直接從 MQ 獲取數據，不使用緩存。
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <div class="auto-refresh-container">
          <label for="refreshInterval">自動刷新間隔:</label>
          <select id="refreshInterval" class="form-select">
            <option value="0">關閉</option>
            <option value="5000">5 秒</option>
            <option value="10000" selected>10 秒</option>
            <option value="30000">30 秒</option>
            <option value="60000">1 分鐘</option>
          </select>
        </div>

        <button id="refreshBtn" class="btn btn-primary refresh-btn">
          刷新數據
          <span class="loading">
            <span class="loading-spinner"></span>
          </span>
        </button>
      </div>

      <div class="row">
        <!-- Queue Manager 信息 -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Queue Manager 信息</div>
            <div class="card-body">
              <div id="qmgrInfo">
                <p>加載中...</p>
              </div>
              <div class="last-updated" id="qmgrInfoUpdated"></div>
            </div>
          </div>
        </div>

        <!-- 連接測試 -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">連接測試</div>
            <div class="card-body">
              <button
                id="testConnectionBtn"
                class="btn btn-outline-primary mb-3"
              >
                測試連接
                <span class="loading">
                  <span class="loading-spinner"></span>
                </span>
              </button>
              <div id="connectionResult">
                <p>點擊「測試連接」按鈕開始測試</p>
              </div>
              <div class="last-updated" id="connectionResultUpdated"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 隊列深度 -->
      <div class="card">
        <div class="card-header">隊列深度</div>
        <div class="card-body">
          <div id="queueDepths">
            <p>加載中...</p>
          </div>
          <div class="last-updated" id="queueDepthsUpdated"></div>

          <!-- 添加隊列表單 -->
          <div class="add-queue-form">
            <h5>添加隊列到監控列表</h5>
            <div class="input-group mb-3">
              <input
                type="text"
                id="newQueueName"
                class="form-control"
                placeholder="輸入隊列名稱"
              />
              <button
                class="btn btn-outline-primary"
                type="button"
                id="addQueueBtn"
              >
                添加
              </button>
            </div>
            <div id="addQueueResult"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 全局變量
      let refreshIntervalId = null;
      let lastUpdated = {
        qmgrInfo: null,
        queueDepths: null,
        connectionResult: null,
      };

      // 頁面加載完成後獲取數據
      document.addEventListener("DOMContentLoaded", function () {
        fetchAllData();

        // 點擊刷新按鈕時重新獲取數據
        document
          .getElementById("refreshBtn")
          .addEventListener("click", function () {
            fetchAllData(true);
          });

        // 點擊測試連接按鈕
        document
          .getElementById("testConnectionBtn")
          .addEventListener("click", function () {
            testConnection();
          });

        // 點擊添加隊列按鈕
        document
          .getElementById("addQueueBtn")
          .addEventListener("click", function () {
            addQueueToMonitor();
          });

        // 監聽自動刷新間隔變化
        document
          .getElementById("refreshInterval")
          .addEventListener("change", function () {
            const interval = parseInt(this.value);
            setupAutoRefresh(interval);
          });

        // 初始化自動刷新
        setupAutoRefresh(
          parseInt(document.getElementById("refreshInterval").value)
        );
      });

      // 設置自動刷新
      function setupAutoRefresh(interval) {
        // 清除現有的定時器
        if (refreshIntervalId) {
          clearInterval(refreshIntervalId);
          refreshIntervalId = null;
        }

        // 如果間隔大於 0，設置新的定時器
        if (interval > 0) {
          refreshIntervalId = setInterval(function () {
            fetchAllData();
          }, interval);
        }
      }

      // 獲取所有 MQ 信息
      function fetchAllData(showLoading = false) {
        if (showLoading) {
          document.querySelector("#refreshBtn .loading").style.display =
            "inline-block";
        }

        // 獲取 Queue Manager 信息
        fetchData("/api/mq-monitor", function (data) {
          displayQueueManagerInfo(data);
          lastUpdated.qmgrInfo = new Date();
          updateLastUpdatedTime("qmgrInfoUpdated", lastUpdated.qmgrInfo);
        });

        // 獲取所有隊列深度
        fetchData("/api/mq-monitor/queues/depths", function (data) {
          displayQueueDepths(data);
          lastUpdated.queueDepths = new Date();
          updateLastUpdatedTime("queueDepthsUpdated", lastUpdated.queueDepths);

          if (showLoading) {
            document.querySelector("#refreshBtn .loading").style.display =
              "none";
          }
        });
      }

      // 測試 MQ 連接
      function testConnection() {
        const button = document.getElementById("testConnectionBtn");
        const loading = button.querySelector(".loading");

        // 顯示加載中
        button.disabled = true;
        loading.style.display = "inline-block";
        document.getElementById("connectionResult").innerHTML =
          "<p>正在測試連接...</p>";

        fetchData("/api/mq-monitor/test-connection", function (data) {
          displayConnectionResult(data);
          lastUpdated.connectionResult = new Date();
          updateLastUpdatedTime(
            "connectionResultUpdated",
            lastUpdated.connectionResult
          );

          // 隱藏加載中
          button.disabled = false;
          loading.style.display = "none";
        });
      }

      // 添加隊列到監控列表
      function addQueueToMonitor() {
        const queueName = document.getElementById("newQueueName").value.trim();
        if (!queueName) {
          document.getElementById("addQueueResult").innerHTML =
            '<p class="text-danger">請輸入隊列名稱</p>';
          return;
        }

        fetch(
          "/api/mq-monitor/queues/monitor?queueName=" +
            encodeURIComponent(queueName),
          {
            method: "POST",
          }
        )
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("addQueueResult").innerHTML =
              '<p class="text-success">' + data.message + "</p>";
            document.getElementById("newQueueName").value = "";

            // 重新獲取隊列深度
            setTimeout(function () {
              fetchData("/api/mq-monitor/queues/depths", function (data) {
                displayQueueDepths(data);
                lastUpdated.queueDepths = new Date();
                updateLastUpdatedTime(
                  "queueDepthsUpdated",
                  lastUpdated.queueDepths
                );
              });
            }, 1000);
          })
          .catch((error) => {
            document.getElementById("addQueueResult").innerHTML =
              '<p class="text-danger">添加隊列失敗: ' + error.message + "</p>";
          });
      }

      // 通用數據獲取函數
      function fetchData(url, callback) {
        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error("網絡響應不正常");
            }
            return response.json();
          })
          .then((data) => {
            callback(data);
          })
          .catch((error) => {
            console.error("獲取數據失敗:", error);
            callback({ error: error.message });
          });
      }

      // 更新最後更新時間
      function updateLastUpdatedTime(elementId, time) {
        const element = document.getElementById(elementId);
        if (element && time) {
          element.textContent = "最後更新: " + time.toLocaleTimeString();
        }
      }

      // 顯示 Queue Manager 信息
      function displayQueueManagerInfo(data) {
        if (data.error) {
          document.getElementById("qmgrInfo").innerHTML =
            '<p class="error-message">獲取 Queue Manager 信息失敗: ' +
            data.error +
            "</p>";
          return;
        }

        let html = '<table class="table table-striped">';
        html +=
          "<tr><th>Queue Manager 名稱</th><td>" +
          (data.queueManagerName || "N/A") +
          "</td></tr>";

        let statusClass =
          data.queueManagerStatus === "RUNNING"
            ? "status-running"
            : "status-error";
        html +=
          '<tr><th>狀態</th><td class="' +
          statusClass +
          '">' +
          (data.queueManagerStatus || "N/A") +
          "</td></tr>";

        html +=
          "<tr><th>連接狀態</th><td>" +
          (data.connected
            ? '<span class="status-running">已連接</span>'
            : '<span class="status-error">未連接</span>') +
          "</td></tr>";

        if (data.defaultQueueName) {
          html +=
            "<tr><th>默認隊列</th><td>" + data.defaultQueueName + "</td></tr>";
          html +=
            "<tr><th>默認隊列深度</th><td>" +
            (data.defaultQueueDepth >= 0 ? data.defaultQueueDepth : "N/A") +
            "</td></tr>";
        }

        if (data.executionTimeMs) {
          html +=
            "<tr><th>執行時間</th><td>" +
            data.executionTimeMs +
            " 毫秒</td></tr>";
        }

        html += "</table>";

        document.getElementById("qmgrInfo").innerHTML = html;
      }

      // 顯示連接測試結果
      function displayConnectionResult(data) {
        let html = "";

        if (data.status === "success") {
          html += '<p class="status-running">連接成功!</p>';
          html += '<table class="table table-striped">';
          html +=
            "<tr><th>Queue Manager</th><td>" +
            (data.queueManager || "N/A") +
            "</td></tr>";
          html += "<tr><th>狀態</th><td>已連接</td></tr>";
          html += "</table>";
        } else {
          html += '<p class="status-error">連接失敗!</p>';
          html += '<table class="table table-striped">';
          html +=
            "<tr><th>錯誤信息</th><td>" +
            (data.message || "N/A") +
            "</td></tr>";
          if (data.reasonCode) {
            html +=
              "<tr><th>原因代碼</th><td>" +
              data.reasonCode +
              " (" +
              (data.reasonCodeExplained || "Unknown") +
              ")</td></tr>";
          }
          html += "<tr><th>狀態</th><td>未連接</td></tr>";
          html += "</table>";
        }

        document.getElementById("connectionResult").innerHTML = html;
      }

      // 顯示隊列深度
      function displayQueueDepths(data) {
        if (data.error) {
          document.getElementById("queueDepths").innerHTML =
            '<p class="error-message">獲取隊列深度失敗: ' + data.error + "</p>";
          return;
        }

        let depths = data.depths || data;

        if (Object.keys(depths).length === 0) {
          document.getElementById("queueDepths").innerHTML =
            "<p>沒有可用的隊列</p>";
          return;
        }

        let html = '<table class="table table-striped">';
        html += "<thead><tr><th>隊列名稱</th><th>深度</th></tr></thead>";
        html += "<tbody>";

        for (const [queueName, depth] of Object.entries(depths)) {
          html += "<tr>";
          html += "<td>" + queueName + "</td>";
          html += "<td>" + (depth >= 0 ? depth : "N/A") + "</td>";
          html += "</tr>";
        }

        html += "</tbody></table>";

        if (data.executionTimeMs) {
          html += '<div class="performance-info">';
          html +=
            "<p><strong>執行時間:</strong> " +
            data.executionTimeMs +
            " 毫秒</p>";
          html += "</div>";
        }

        document.getElementById("queueDepths").innerHTML = html;
      }
    </script>
  </body>
</html>
